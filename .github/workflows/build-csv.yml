name: Build Survey CSV

on:
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * *"   # UTC 18:00 → JST 翌日 03:00

permissions:
  contents: write
  issues: read

jobs:
  rebuild:
    runs-on: ubuntu-latest

    concurrency:
      group: survey-csv
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Rebuild data/survey.csv from OPEN issues with label "survey" (latest per player)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            const outPath = path.join(process.env.GITHUB_WORKSPACE, 'data', 'survey.csv');
            fs.mkdirSync(path.dirname(outPath), { recursive: true });

            const headers = ['timestamp','language','player_name','Q2_time','Q3_time','Q4_day'];

            function csvEscape(v) {
              if (v == null) return '';
              const s = String(v);
              if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
              return s;
            }

            function parseIssueToRow(issue) {
              const body = issue.body || '';
              let data = null;

              // ```json ... ``` を優先
              const m = body.match(/```json\s*([\s\S]*?)\s*```/i);
              if (m) {
                try { data = JSON.parse(m[1]); } catch (_) {}
              }

              // fallback: body全体がJSON
              if (!data) {
                try { data = JSON.parse(body); } catch (_) {}
              }

              if (!data || typeof data !== 'object') return null;

              const row = {
                timestamp: data.timestamp || issue.created_at || new Date().toISOString(),
                language: data.language || '',
                player_name: data.player_name || '',
                Q2_time: data.Q2_time || '',
                Q3_time: data.Q3_time || '',
                Q4_day: data.Q4_day || '',
              };

              if (!row.player_name) return null;
              return row;
            }

            // --- OPEN + label: survey だけ取得 ---
            const all = await github.paginate(
              github.rest.issues.listForRepo,
              { owner, repo, state: 'open', labels: 'survey', per_page: 100 }
            );

            const issues = all.filter(x => !x.pull_request);

            // --- player_name ごとに最新(timestamp最大)だけ残す ---
            const latestByPlayer = new Map();

            for (const issue of issues) {
              const row = parseIssueToRow(issue);
              if (!row) continue;

              const key = String(row.player_name);

              const prev = latestByPlayer.get(key);
              if (!prev) {
                latestByPlayer.set(key, row);
                continue;
              }

              // timestamp はISO想定：文字列比較でOK（安全のためDate比較も可能）
              if (String(row.timestamp) > String(prev.timestamp)) {
                latestByPlayer.set(key, row);
              }
            }

            const rows = Array.from(latestByPlayer.values());

            // 出力を安定化（timestamp順）
            rows.sort((a,b) => String(a.timestamp).localeCompare(String(b.timestamp)));

            const lines = [];
            lines.push(headers.join(','));
            for (const r of rows) {
              lines.push(headers.map(h => csvEscape(r[h])).join(','));
            }

            fs.writeFileSync(outPath, lines.join('\n') + '\n', 'utf8');

            console.log(`Wrote ${rows.length} rows (latest per player, label=survey, open only) to ${outPath}`);

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/survey.csv
          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi
          git commit -m "Update data/survey.csv (open issues, label=survey, latest per player)"
          git push
