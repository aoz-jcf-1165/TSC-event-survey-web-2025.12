name: Build Survey CSV

on:
  workflow_dispatch:
  schedule:
    - cron: "0 18 * * *"   # UTC 18:00 → JST 翌日 03:00
  issues:
    types: [opened, edited, reopened, closed]  # labeled/unlabeled は二重発火の元なので使わない

permissions:
  contents: write
  issues: read

concurrency:
  group: survey-csv
  cancel-in-progress: false

jobs:
  rebuild:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Rebuild data/survey.csv and data/survey_all.csv from issues
        id: rebuild
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require("fs");
            const path = require("path");

            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            const outDir = path.join(process.cwd(), "data");
            if (!fs.existsSync(outDir)) fs.mkdirSync(outDir, { recursive: true });

            const headers = ["timestamp","language","player_name","Q2_time","Q3_time","Q4_day"];

            function csvEscape(v) {
              if (v == null) return "";
              const s = String(v);
              if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
              return s;
            }

            function toCSV(rows) {
              const lines = [];
              lines.push(headers.join(","));
              for (const r of rows) {
                lines.push(headers.map(h => csvEscape(r[h] ?? "")).join(","));
              }
              return lines.join("\n") + "\n";
            }

            function extractJsonFromBody(body) {
              if (!body) return null;

              // まず ```json ... ``` を探す
              const m = body.match(/```json\s*([\s\S]*?)\s*```/i);
              if (m && m[1]) {
                try { return JSON.parse(m[1]); } catch { /* fallthrough */ }
              }

              // フォールバック：本文内に JSON っぽい塊があれば拾う（保険）
              // ※誤検出を避けるため "player_name" を含む場合のみ
              const idx = body.indexOf("{");
              if (idx >= 0 && body.includes('"player_name"')) {
                const tail = body.slice(idx);
                const end = tail.lastIndexOf("}");
                if (end >= 0) {
                  const candidate = tail.slice(0, end + 1);
                  try { return JSON.parse(candidate); } catch {}
                }
              }
              return null;
            }

            async function listAllSurveyIssuesStateAll() {
              // GitHub REST: issues.listForRepo をページネーション
              // state=all で open/closed 両方。labels=survey で対象固定。
              const per_page = 100;
              let page = 1;
              let all = [];

              while (true) {
                const res = await github.rest.issues.listForRepo({
                  owner, repo,
                  state: "all",
                  labels: "survey",
                  per_page,
                  page,
                  sort: "created",
                  direction: "desc",
                });

                const items = res.data || [];
                // PR が混ざる可能性があるので弾く（issues API だが稀に入る）
                const issuesOnly = items.filter(it => !it.pull_request);

                all.push(...issuesOnly);

                if (items.length < per_page) break;
                page++;
                if (page > 50) break; // 安全弁（通常ここまで行かない）
              }

              return all;
            }

            const issues = await listAllSurveyIssuesStateAll();

            // 1) 全履歴 rows
            const allRows = [];
            for (const it of issues) {
              const data = extractJsonFromBody(it.body);
              if (!data) continue;

              const row = {
                timestamp: data.timestamp || it.created_at || "",
                language: data.language || "",
                player_name: data.player_name || "",
                Q2_time: data.Q2_time || "",
                Q3_time: data.Q3_time || "",
                Q4_day: data.Q4_day || "",
              };

              // 必須が揃わないものはスキップ（空行を作らない）
              if (!row.player_name || !row.language || !row.Q2_time || !row.Q3_time || !row.Q4_day) {
                continue;
              }

              allRows.push(row);
            }

            // timestamp 降順（新しい→古い）
            allRows.sort((a,b) => String(b.timestamp).localeCompare(String(a.timestamp)));

            // 2) latest per player
            const latestMap = new Map();
            for (const r of allRows) {
              const key = r.player_name;
              if (!latestMap.has(key)) {
                latestMap.set(key, r); // allRows は新しい順なので最初が最新
              }
            }
            const latestRows = Array.from(latestMap.values());

            // 出力
            const csvAll = toCSV(allRows);
            const csvLatest = toCSV(latestRows);

            fs.writeFileSync(path.join(outDir, "survey_all.csv"), csvAll, "utf8");
            fs.writeFileSync(path.join(outDir, "survey.csv"), csvLatest, "utf8");

            core.setOutput("count_all", String(allRows.length));
            core.setOutput("count_latest", String(latestRows.length));

      - name: Commit and push if changed
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/survey.csv data/survey_all.csv

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update data/survey.csv and data/survey_all.csv"
          git push
