name: Build Survey CSV

on:
  # 手動実行
  workflow_dispatch:

  # 毎晩 JST 03:00 に自動再集計
  schedule:
    - cron: "0 18 * * *"   # UTC 18:00 → JST 03:00

jobs:
  rebuild:
    runs-on: ubuntu-latest

    # CSV を触るジョブは常に 1 本だけ
    concurrency:
      group: survey-csv
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Rebuild data/survey.csv from all issues
        id: rebuild
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            const headers = [
              'timestamp',
              'language',
              'player_name',
              'Q2_time',
              'Q3_time',
              'Q4_day',
            ];

            function escapeCSV(value) {
              if (value == null) return '';
              const s = String(value);
              if (/[",\n]/.test(s)) {
                return `"${s.replace(/"/g, '""')}"`;
              }
              return s;
            }

            function getFirst(map, keys) {
              for (const k of keys) {
                if (map[k]) return map[k];
              }
              return '';
            }

            function parseIssueBody(body) {
              const lines = (body || '').split(/\r?\n/);
              const map = {};

              for (const line of lines) {
                const m = line.match(/^\s*\|\s*([^|]+?)\s*\|\s*(.*?)\s*\|\s*$/);
                if (m) {
                  const key = m[1].trim();
                  const value = m[2].trim();
                  map[key] = value;
                }
              }

              const rowObject = {
                timestamp: getFirst(map, ['timestamp']),
                language: getFirst(map, ['language']),
                player_name: getFirst(map, ['player_name']),
                // 新旧すべてのキーに対応
                Q2_time: getFirst(map, ['Q2_time', 'Q02_time', 'Q02 (time)', 'Q2 (time)']),
                Q3_time: getFirst(map, ['Q3_time', 'Q03_time', 'Q03 (time)', 'Q3 (time)']),
                Q4_day:  getFirst(map, ['Q4_day',  'Q04_day', 'Q04 (day)',  'Q4 (day)']),
              };

              const hasValue = Object.values(rowObject).some(v => (v || '') !== '');
              return hasValue ? rowObject : null;
            }

            core.info(`Fetching issues...`);

            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              { owner, repo, state: 'all', per_page: 100 }
            );

            const latestByPlayer = new Map();

            for (const issue of issues) {
              if (!issue.title?.startsWith("Survey response from:")) continue;

              const rowObject = parseIssueBody(issue.body || '');
              if (!rowObject?.player_name) continue;

              const key = rowObject.player_name;
              const createdAt = new Date(issue.created_at);

              const existing = latestByPlayer.get(key);
              if (!existing || createdAt > existing.createdAt) {
                latestByPlayer.set(key, { createdAt, row: rowObject });
              }
            }

            const finalRows = [...latestByPlayer.values()]
              .sort((a, b) => a.createdAt - b.createdAt)
              .map(e => e.row);

            const dataDir = path.join(process.cwd(), 'data');
            fs.mkdirSync(dataDir, { recursive: true });

            const csvPath = path.join(dataDir, 'survey.csv');

            let csv = headers.join(',');
            if (finalRows.length) {
              csv += '\n' + finalRows
                .map(r => headers.map(h => escapeCSV(r[h])).join(','))
                .join('\n');
            }
            csv += '\n';

            fs.writeFileSync(csvPath, csv, 'utf8');

            core.setOutput('csv_path', csvPath);
            core.setOutput('row_count', finalRows.length);

      - name: Commit and push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          git config user.name "${GITHUB_ACTOR}"
          git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"

          git add data/survey.csv

          if git diff --cached --quiet; then
            echo "No updates to commit."
            exit 0
          fi

          git commit -m "Nightly rebuild survey.csv"
          git pull --rebase origin "$BRANCH" || true
          git push origin HEAD:"$BRANCH"
