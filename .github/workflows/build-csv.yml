name: Build Survey CSV

on:
  # Collect survey responses から呼び出す
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue number that contains the survey response"
        required: true
        type: string

jobs:
  build_csv:
    runs-on: ubuntu-latest

    steps:
      # 1) リポジトリを取得（履歴も持ってくる）
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) アンケート Issue の本文を取得
      - name: Load issue body
        id: issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const issueNumber = parseInt('${{ github.event.inputs.issue_number }}', 10);

            const { data: issue } = await github.rest.issues.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });

            core.setOutput('body', issue.body || '');

      # 3) data フォルダを必ず作成
      - name: Create data directory
        run: mkdir -p data

      # 4) Issue の Markdown テーブルから値を取り出して 1 行の CSV に変換
      - name: Build CSV row from issue body
        id: csv
        env:
          ISSUE_BODY: ${{ steps.issue.outputs.body }}
        run: |
          body="$(printf '%s\n' "$ISSUE_BODY")"

          # Markdown テーブルの 2 列目（項目名）をキーに 3 列目（値）を取得
          get_value () {
            printf '%s\n' "$body" \
              | awk -F'|' -v key="$1" '
                  $2 ~ key {
                    val=$3
                    gsub(/^[ \t]+|[ \t]+$/, "", val)
                    gsub(/\r/, "", val)
                    print val
                    exit
                  }
                '
          }

          timestamp="$(get_value "timestamp")"
          language="$(get_value "Language")"
          player_name="$(get_value "Player")"
          q02="$(get_value "Q2")"
          q03="$(get_value "Q3")"
          q04="$(get_value "Q4")"

          # CSV 用に " をエスケープしてダブルクオートで囲む
          esc () {
            v="$1"
            v="${v//\"/\"\"}"
            printf '"%s"' "$v"
          }

          row="$(printf '%s,%s,%s,%s,%s,%s\n' \
            "$(esc "$timestamp")" \
            "$(esc "$language")" \
            "$(esc "$player_name")" \
            "$(esc "$q02")" \
            "$(esc "$q03")" \
            "$(esc "$q04")")"

          echo "row=$row" >> "$GITHUB_OUTPUT"

      # 5) data/survey.csv にヘッダー付きで追記
      - name: Append row to data/survey.csv
        run: |
          FILE="data/survey.csv"

          if [ ! -f "$FILE" ]; then
            echo 'timestamp,language,player_name,Q02_time,Q03_time,Q04_day' > "$FILE"
          fi

          echo '${{ steps.csv.outputs.row }}' >> "$FILE"

      # 6) コミットする（変更が無いときはスキップ）
      - name: Commit CSV
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add data/survey.csv

          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update survey.csv for issue #${{ github.event.inputs.issue_number }}"

      # 7) 競合に強い push（force-with-lease）
      - name: Push to GitHub
        uses: ad-m/github-push-action@v0.6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: main          # ★ブランチ名が master の場合はここを master に変更
          force_with_lease: true
