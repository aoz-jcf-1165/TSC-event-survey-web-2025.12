name: Collect Survey Responses (Rebuild CSV)

on:
  issues:
    types: [labeled]

jobs:
  rebuild:
    # survey ラベルが付いたときだけ実行
    if: github.event.label.name == 'survey'
    runs-on: ubuntu-latest

    concurrency:
      group: survey-csv
      cancel-in-progress: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Rebuild data/survey.csv from open survey issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            const headers = [
              'timestamp',
              'language',
              'player_name',
              'Q2_time',
              'Q3_time',
              'Q4_day',
            ];

            function escapeCSV(v) {
              if (v == null) return '';
              const s = String(v);
              return /[",\n]/.test(s)
                ? `"${s.replace(/"/g, '""')}"`
                : s;
            }

            // open + survey ラベル付き issue を全件取得
            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              {
                owner,
                repo,
                state: 'open',
                labels: 'survey',
                per_page: 100,
              }
            );

            const rows = [headers.join(',')];

            for (const issue of issues) {
              const body = issue.body || '';
              const get = (k) => {
                const m = body.match(new RegExp(`^${k}:\\s*(.*)$`, 'mi'));
                return m ? m[1].trim() : '';
              };

              const row = [
                issue.created_at,
                get('language'),
                get('player_name'),
                get('Q2_time'),
                get('Q3_time'),
                get('Q4_day'),
              ].map(escapeCSV);

              rows.push(row.join(','));
            }

            fs.writeFileSync('data/survey.csv', rows.join('\n'));

      - name: Commit CSV
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/survey.csv
          git commit -m "Update data/survey.csv (open survey issues only)" || echo "No changes"
          git push
