name: Collect Survey Responses (Rebuild CSV)

on:
  issues:
    types: [opened, edited, reopened, labeled, unlabeled]
  workflow_dispatch:

permissions:
  contents: write
  issues: read

concurrency:
  group: survey-csv
  cancel-in-progress: false

jobs:
  rebuild:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Rebuild data/survey.csv from OPEN issues (latest per player)
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            const owner = context.repo.owner;
            const repo  = context.repo.repo;

            const OUT_FILE = path.join(process.cwd(), 'data', 'survey.csv');

            const headers = [
              'timestamp',
              'language',
              'player_name',
              'Q2_time',
              'Q3_time',
              'Q4_day',
            ];

            function escapeCSV(value) {
              if (value == null) return '';
              const s = String(value);
              if (/[",\n\r]/.test(s)) return `"${s.replace(/"/g, '""')}"`;
              return s;
            }

            function extractJsonFromIssueBody(body) {
              if (!body) return null;

              // Expect: ```json ... ```
              const m = body.match(/```json\s*([\s\S]*?)\s*```/i);
              if (!m) return null;

              try {
                return JSON.parse(m[1]);
              } catch {
                return null;
              }
            }

            async function listAllOpenIssues() {
              // OPEN only (closed are excluded as requested)
              const per_page = 100;
              let page = 1;
              let all = [];

              while (true) {
                const res = await github.rest.issues.listForRepo({
                  owner,
                  repo,
                  state: 'open',
                  per_page,
                  page,
                });

                const items = res.data || [];
                // Exclude pull requests
                const issuesOnly = items.filter(x => !x.pull_request);
                all = all.concat(issuesOnly);

                if (items.length < per_page) break;
                page += 1;
              }

              return all;
            }

            const issues = await listAllOpenIssues();

            // latest-by-player_name (case-sensitive by default; your “今まで通り”に合わせる)
            // ※もし将来 “Kenji/kenji を同一扱い” にしたいならここを toLowerCase() に変更
            const latestByPlayer = new Map();

            for (const issue of issues) {
              const data = extractJsonFromIssueBody(issue.body);
              if (!data) continue;

              const row = {
                timestamp: data.timestamp || '',
                language: data.language || '',
                player_name: data.player_name || '',
                Q2_time: data.Q2_time || '',
                Q3_time: data.Q3_time || '',
                Q4_day: data.Q4_day || '',
              };

              if (!row.player_name || !row.timestamp) continue;

              const key = row.player_name;

              const prev = latestByPlayer.get(key);
              if (!prev) {
                latestByPlayer.set(key, row);
                continue;
              }

              // Compare timestamp (ISO expected)
              if (String(row.timestamp) > String(prev.timestamp)) {
                latestByPlayer.set(key, row);
              }
            }

            const rows = Array.from(latestByPlayer.values())
              .sort((a, b) => String(a.player_name).localeCompare(String(b.player_name)));

            // Ensure data/ exists
            fs.mkdirSync(path.dirname(OUT_FILE), { recursive: true });

            // Write CSV
            const lines = [];
            lines.push(headers.join(','));
            for (const r of rows) {
              const line = headers.map(h => escapeCSV(r[h])).join(',');
              lines.push(line);
            }

            fs.writeFileSync(OUT_FILE, lines.join('\n') + '\n', 'utf-8');

            console.log(`Wrote ${rows.length} rows to ${OUT_FILE}`);

      - name: Commit & push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/survey.csv
          if git diff --cached --quiet; then
            echo "No changes."
            exit 0
          fi
          git commit -m "Rebuild survey.csv (open issues, latest per player)"
          git push
